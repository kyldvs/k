# Bootstrap Profile Init - Implementation Plan

## Prerequisites
- Existing bootstrap build system (just bootstrap build-all)
- Test infrastructure (just test mobile termux)
- Understanding of bootstrap/lib/ modular component system

## Architecture Overview

This implementation adds minimal .profile initialization to bootstrap scripts using:
- **Config files**: Small shell scripts in `bootstrap/lib/configs/` containing env vars
- **Profile step**: New step function to copy configs and add sourcing lines to .profile
- **Idempotency**: Grep-based check for source lines (not file existence)
- **Integration**: Adds to termux.txt manifest between packages and next-steps

**Key Design Decision**: Keep configs inline in step function (not separate files) to maintain simplicity - only 2-3 lines of config per component.

## Task Breakdown

### Phase 1: Foundation
- [x] Task 1.1: Create profile initialization step function
  - Files: `bootstrap/lib/steps/profile-init.sh`
  - Dependencies: None
  - Details: Create `init_profile()` function with helper `kd_add_profile_line()`
    - Helper takes: config_name, config_content, source_line
    - Checks: `grep -qF "$source_line" ~/.profile` for idempotency
    - Creates: `~/.config/kyldvs/k/$config_name.sh` with content
    - Appends: source line to ~/.profile if not present
    - Uses: kd_step_start/end/skip pattern from existing steps

### Phase 2: Core Implementation
- [x] Task 2.1: Implement editor config component
  - Files: `bootstrap/lib/steps/profile-init.sh`
  - Dependencies: Task 1.1
  - Details: Add editor config in init_profile()
    - Config content: `export EDITOR=nano`
    - Source line: `[ -f ~/.config/kyldvs/k/kd-editor.sh ] && . ~/.config/kyldvs/k/kd-editor.sh`

- [x] Task 2.2: Implement PATH config component
  - Files: `bootstrap/lib/steps/profile-init.sh`
  - Dependencies: Task 1.1
  - Details: Add PATH config in init_profile()
    - Config content: `export PATH="$HOME/bin:$PATH"`
    - Source line: `[ -f ~/.config/kyldvs/k/kd-path.sh ] && . ~/.config/kyldvs/k/kd-path.sh`
    - Create ~/bin directory if it doesn't exist

### Phase 3: Integration
- [x] Task 3.1: Add profile-init to termux manifest
  - Files: `bootstrap/manifests/termux.txt`
  - Dependencies: Tasks 2.1, 2.2
  - Details: Insert `lib/steps/profile-init.sh` after packages.sh, before next-steps.sh

- [x] Task 3.2: Add profile-init call to termux-main
  - Files: `bootstrap/lib/steps/termux-main.sh`
  - Dependencies: Task 3.1
  - Details: Add `init_profile` call in main bootstrap sequence after install_packages

- [x] Task 3.3: Rebuild bootstrap scripts
  - Files: `bootstrap/termux.sh` (generated)
  - Dependencies: Task 3.2
  - Details: Run `just bootstrap build termux`

### Phase 4: Testing & Validation
- [x] Task 4.1: Add profile validation to mobile tests
  - Files: `src/tests/tests/mobile-termux.test.sh`
  - Dependencies: Task 3.3
  - Details: Add test phase after Phase 12 for .profile validation
    - assert_file "$HOME/.profile"
    - assert_file_contains for both source lines
    - assert_file "$HOME/.config/kyldvs/k/kd-editor.sh"
    - assert_file "$HOME/.config/kyldvs/k/kd-path.sh"
    - Verify EDITOR=nano in new shell
    - Verify ~/bin in PATH

- [x] Task 4.2: Test idempotency specifically for profile
  - Files: `src/tests/tests/mobile-termux.test.sh`
  - Dependencies: Task 4.1
  - Details: Count source lines in .profile before/after second run
    - Should be exactly 2 lines (no duplicates)

- [x] Task 4.3: Run full test suite
  - Files: N/A (test execution)
  - Dependencies: Task 4.2
  - Details: `just test all` - validate all mobile tests pass

## Files to Create
- `bootstrap/lib/steps/profile-init.sh` - Profile initialization step function

## Files to Modify
- `bootstrap/manifests/termux.txt` - Add profile-init.sh component
- `bootstrap/lib/steps/termux-main.sh` - Add init_profile() call
- `src/tests/tests/mobile-termux.test.sh` - Add profile validation tests
- `bootstrap/termux.sh` - Generated by build system (automatic)

## Testing Strategy
- **Unit-level**: Each config component adds exactly one source line to .profile
- **Integration**: Full bootstrap run creates .profile with correct structure
- **Idempotency**: Running bootstrap twice produces identical .profile
- **Functional**:
  - EDITOR is set to nano in new shell session
  - ~/bin is in PATH and accessible
  - Config files exist at ~/.config/kyldvs/k/
- **Manual verification steps**:
  1. Run `just bootstrap build termux` to regenerate script
  2. Run `just test mobile termux` to validate
  3. Check test output for profile validation phase
  4. Inspect generated .profile in test container

## Risk Assessment
- **Risk 1**: .profile might not be sourced in some shells
  - Mitigation: Document that this is for basic sh/bash, not zsh
  - Acceptable: Per spec, zsh setup comes later for VM

- **Risk 2**: Grep-based idempotency could fail with similar lines
  - Mitigation: Use exact match with grep -qF (fixed string)
  - Low risk: Source lines are very specific and unique

- **Risk 3**: Creating ~/bin might conflict with existing setup
  - Mitigation: Only create if doesn't exist, never delete
  - Safe: mkdir -p is idempotent

## Estimated Complexity
**Simple**

Rationale:
- Single new step file following existing patterns
- No new external dependencies
- Straightforward grep-based idempotency
- Config content is minimal (1-2 lines per component)
- Test additions are basic file/content assertions
- Total changes: ~50-60 lines of code across 4 files

## Implementation Approach
**DIRECT** - All tasks can be completed directly:
- Small scope (4 files modified, 1 created)
- Clear patterns exist in bootstrap/lib/steps/*.sh
- Straightforward implementation following DRY principle
- Rapid iteration for testing

## Notes
- Keep config content minimal - only EDITOR and PATH for now
- Don't over-engineer for future VM/zsh setup
- Source line format is critical: `[ -f /path ] && . /path`
- Follow existing step patterns: kd_step_start, kd_log, kd_step_end
- Ensure proper escaping in grep -qF for special chars
- Consider adding kd_step_skip when profile already configured
