set fallback := true
set shell := ["bash", "-uc"]

[no-cd]
all:
  @echo "Running all tests..."
  @src/tests/run-mobile.sh termux
  @src/tests/run-vmroot.sh
  @src/tests/run-vm.sh

[no-cd]
mobile platform="termux":
  @echo "Testing mobile bootstrap on {{platform}}..."
  @src/tests/run-mobile.sh {{platform}}

[no-cd]
vmroot:
  @echo "Testing vmroot bootstrap..."
  @src/tests/run-vmroot.sh

[no-cd]
vm:
  @echo "Testing VM bootstrap..."
  @src/tests/run-vm.sh

[no-cd]
clean:
  @echo "Cleaning up test containers and volumes..."
  @docker compose -f src/tests/docker-compose.mobile.yml -p k-mobile-test down -v 2>/dev/null || true
  @docker compose -f src/tests/docker-compose.vmroot.yml -p k-vmroot-test down -v 2>/dev/null || true
  @docker compose -f src/tests/docker-compose.vm.yml -p k-vm-test down -v 2>/dev/null || true
  @docker ps -a --filter "name=k-test-*" -q | xargs -r docker rm -f 2>/dev/null || true
  @docker images -q "k-test-*" | xargs -r docker rmi -f 2>/dev/null || true
